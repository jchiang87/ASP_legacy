<?xml version="1.0" encoding="UTF-8"?>
<pipeline
   xmlns="http://glast-ground.slac.stanford.edu/pipeline"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://glast-ground.slac.stanford.edu/pipeline http://glast-ground.slac.stanford.edu/Pipeline-II/schemas/2.0/pipeline.xsd">
<!-- $Header$
-->
<task name="GRB_refinement" version="2.3" type="Data">
  <variables>
    <var name="ST_INST">"/nfs/farm/g/glast/u30/builds/rh9_gcc32/ScienceTools/ScienceTools-v9r2"</var>
    <var name="BINDIR">rh9_gcc32</var>
  </variables>
   <prerequisites>
      <prerequisite name="GCN_NOTICE" type="string"/>
      <prerequisite name="GRB_ID" type="integer"/>
      <prerequisite name="logicalPath" type="string"/>
      <prerequisite name="TSTART" type="integer"/>
      <prerequisite name="TSTOP" type="integer"/>
      <prerequisite name="output_dir" type="string"/>
      <prerequisite name="ASP_PATH" type="string"/>
      <prerequisite name="GRBASPROOT" type="string"/>
      <prerequisite name="PIPELINESERVER" type="string"/>
   </prerequisites>
   <process name="catalogQuery">
     <script><![CDATA[
       outfile = pipeline.createFile("Ft1FileList")
       opt1 = '(%(TSTART)i <= nTStart && nTStop <= %(TSTOP)i)' % locals()
       opt2 = '(nTStart <= %(TSTART)i && %(TSTART)i <= nTStop)' % locals()
       opt3 = '(nTStart <= %(TSTOP)i && %(TSTOP)i <= nTStop)' % locals()
       query = ('DataType == \"FITS\" && (%s || %s || %s)' 
                % (opt1, opt2, opt3))
       datasetList = datacatalog.getDatasets(logicalPath, query)
       datasetList.writeToFile(outfile, 1)
       pipeline.writeFile(outfile)
       ]]></script>
   </process>
   <process name="extractLatData">
      <variables>
         <var name="OUTPUTDIR">${output_dir}</var>
      </variables>
      <job executable="${GRBASPROOT}/${BINDIR}/extractLatData.sh"
           batchOptions="-q short"/>
      <depends>
          <after process="catalogQuery" status="SUCCESS"/>
      </depends>
   </process>
   <process name="refinePosition">
      <variables>
         <var name="OUTPUTDIR">${output_dir}</var>
      </variables>
      <job executable="${GRBASPROOT}/${BINDIR}/refinePosition.sh"
           batchOptions="-q short"/>
      <depends>
          <after process="extractLatData" status="SUCCESS"/>
      </depends>
   </process>
   <process name="tsMap">
      <variables>
         <var name="OUTPUTDIR">${output_dir}</var>
      </variables>
      <job executable="${GRBASPROOT}/${BINDIR}/tsMap.sh" 
           batchOptions="-q long"/>
      <depends>
          <after process="refinePosition" status="SUCCESS"/>
      </depends>
   </process>
   <process name="LatGrbSpectrum">
      <variables>
         <var name="OUTPUTDIR">${output_dir}</var>
      </variables>
      <job executable="${GRBASPROOT}/${BINDIR}/LatGrbSpectrum.sh"
           batchOptions="-q short"/>
      <depends>
          <after process="refinePosition" status="SUCCESS"/>
      </depends>
   </process>
</task>
</pipeline>
