<?xml version="1.0" encoding="UTF-8"?>
<pipeline
   xmlns="http://glast-ground.slac.stanford.edu/pipeline"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://glast-ground.slac.stanford.edu/pipeline http://glast-ground.slac.stanford.edu/Pipeline-II/schemas/2.0/pipeline.xsd">
<!-- $Header$
-->
<task name="AspLauncher" version="0.1" type="Data">
  <variables>
    <var name="ST_INST">"/nfs/farm/g/glast/u30/builds/rh9_gcc32/ScienceTools/ScienceTools-v9r4p1"</var>
    <var name="BINDIR">rh9_gcc32</var>
    <var name="minimum_coverage">0.70</var>
  </variables>
  <prerequisites>
    <prerequisite name="folder" type="string"/>
    <prerequisite name="nDownlink" type="integer"/>
    <prerequisite name="SixHour_interval" type="integer"/>
    <prerequisite name="SixHour_nMetStart" type="integer"/>
    <prerequisite name="SixHour_nMetStop" type="integer"/>
    <prerequisite name="Daily_interval" type="integer"/>
    <prerequisite name="Daily_nMetStart" type="integer"/>
    <prerequisite name="Daily_nMetStop" type="integer"/>
    <prerequisite name="Weekly_interval" type="integer"/>
    <prerequisite name="Weekly_nMetStart" type="integer"/>
    <prerequisite name="Weekly_nMetStop" type="integer"/>
    <prerequisite name="GRBOUTPUTDIR" type="string"/>
    <prerequisite name="DRPOUTPUTDIR" type="string"/>
    <prerequisite name="PGWAVEOUTPUTDIR" type="string"/>
    <prerequisite name="ASP_PATH" type="string"/>
    <prerequisite name="PIPELINESERVER" type="string"/>
    <prerequisite name="ASPLAUNCHERROOT" type="string"/>
  </prerequisites>
  <process name="catalogQueries">
    <script>
      <![CDATA[
        def query(outfile, path, TSTART, TSTOP):
            output = pipeline.createFile(outfile)
            opt1 = '(%(TSTART)i <= nMetStart && nMetStop <= %(TSTOP)i)' % locals()
            opt2 = '(nMetStart <= %(TSTART)i && %(TSTART)i <= nMetStop)' % locals()
            opt3 = '(nMetStart <= %(TSTOP)i && %(TSTOP)i <= nMetStop)' % locals()
            query = ('DataType == \"%s\" && (%s || %s || %s)' 
                     % (path, opt1, opt2, opt3))
            datasetList = datacatalog.getDatasets(folder+'/*', query)
            datasetList.writeToFile(output, 1)
            pipeline.writeFile(output)
        query("Ft1FileList_6hr", "FT1", SixHour_nMetStart, SixHour_nMetStop)
        query("Ft2FileList_6hr", "FT2", SixHour_nMetStart, SixHour_nMetStop)
        query("Ft1FileList_day", "FT1", Daily_nMetStart, Daily_nMetStop)
        query("Ft2FileList_day", "FT2", Daily_nMetStart, Daily_nMetStop)
        query("Ft1FileList_week", "FT1", Weekly_nMetStart, Weekly_nMetStop)
        query("Ft2FileList_week", "FT2", Weekly_nMetStart, Weekly_nMetStop)
    ]]></script>
  </process>
  <process name="launchStreams">
    <job executable="${ASPLAUNCHERROOT}/${BINDIR}/launchStreams.sh"
         batchOptions="-q short"/>
    <depends>
      <after process="catalogQueries" status="SUCCESS"/>
    </depends>
  </process>
</task>
</pipeline>
