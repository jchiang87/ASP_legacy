<?xml version="1.0" encoding="UTF-8"?>
<pipeline
   xmlns="http://glast-ground.slac.stanford.edu/pipeline"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://glast-ground.slac.stanford.edu/pipeline http://glast-ground.slac.stanford.edu/Pipeline-II/schemas/2.0/pipeline.xsd">
<!-- $Header$
-->
<task name="PGWave" version="2.2" type="Data">
  <variables>
    <!-- Default values that can be overridden at the command line. -->
    <var name="ST_INST">"/nfs/farm/g/glast/u30/builds/rh9_gcc32/ScienceTools/ScienceTools-v9r3p1"</var>
    <var name="BINDIR">rh9_gcc32</var>
  </variables>
  <prerequisites>
    <prerequisite name="logicalPath" type="string"/>
    <prerequisite name="OUTPUTDIR" type="string"/>
    <prerequisite name="DownlinkId" type="integer"/>
    <prerequisite name="ASP_PATH" type="string"/>
    <prerequisite name="CATDIR" type="string"/>
    <prerequisite name="PGWAVEROOT" type="string"/>
  </prerequisites>

  <process name="catalogQuery">
    <script>
      <![CDATA[
        def query(outfile, type, DownlinkId):
            output = pipeline.createFile(outfile)
            query = 'nDownlink == %i && DataType=="%s"' % (DownlinkId, type)
            datasetList = datacatalog.getDatasets(logicalPath+'/*', query)
            datasetList.writeToFile(output)
            pipeline.writeFile(output)
        query("Ft1FileList", "FT1", DownlinkId)
        query("Ft2FileList", "FT2", DownlinkId)
        ]]></script>
  </process>

  <process name="getPgwInputData">
    <job executable="${PGWAVEROOT}/${BINDIR}/getPgwInputData.sh" 
         batchOptions=" -q short"/>
    <depends>
      <after process="catalogQuery" status="SUCCESS"/>
    </depends>
  </process>

  <process name="runpgw">
    <job executable="${PGWAVEROOT}/${BINDIR}/runpgw.sh"
         batchOptions=" -q medium"/>
    <depends>
      <after process="getPgwInputData" status="SUCCESS"/>
    </depends>
  </process>

  <process name="registerData">
    <script><![CDATA[
    rootname = 'Filtered_evt'
    exts = ('.fits', '_map.fits', '_map.list', '_map.reg', '_map_pgw_out.fits', '_map_ait.gif')
    files = [rootname + '/' + ext for ext in exts]
    types = ('EVENTS', 'SKYMAP', 'PGWAVESOURCESLIST', 'DS9REGIONS', 'FSUMMARY', 'GIFSKYMAP')
    for outfile, type in zip(files, types):
        logicalPath = '/ServiceChallenge/55Day/ASP/FlareMonitoring/%i:' % DownlinkId
        filePath = '%s/%s' % (OUTPUTDIR, outfile)
        datacatalog.registerDataset(type, logicalPath, filePath)
    ]]></script>
    <depends>
      <after process="runpgw" status="SUCCESS"/>
    </depends>
  </process>

</task><!--PGWave-->

</pipeline>
